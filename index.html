<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>OpenManus</title>
  </head>
  <style>
    :root {
      --bg-color: #272728;
      --text-color: #fff;
      --secondary-bg: #212122;
      --border-color: #4a4b53;
      --highlight-color: #dadada;
      --accent-color: #10a37f;
      --success-color: #4caf50;
      --error-color: #f44336;
      --warning-color: #ff9800;
      --info-color: #2196f3;
      --message-bg: #565458;
      --user-message-bg: #363537;
      --sidebar-width: 260px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Söhne", "Inter", -apple-system, BlinkMacSystemFont,
        sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 0.8rem 1rem;
      background-color: var(--secondary-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100px;
    }

    .logo {
      width: 100px;
      margin-left: 3.5rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-dot.active {
      background-color: var(--accent-color);
      box-shadow: 0 0 5px var(--accent-color);
    }

    .status-dot.inactive {
      background-color: var(--error-color);
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--secondary-bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--highlight-color);
    }

    .task-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .task-item {
      margin-bottom: 0.5rem;
      padding: 0.75rem;
      background-color: transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .task-item .timestamp {
      font-size: 0.7rem;
      color: var(--text-color);
      opacity: 0.25;
      margin-top: 0.2rem;
      margin-top: 0.3rem;
    }

    .task-item.selected {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scroll-behavior: smooth;
      padding: 0rem 30rem;
      display: flex;
      flex-direction: column;
    }

    .message {
      padding: 1rem;
      display: flex;
      align-items: flex-start;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      margin: 1rem 2rem;
      max-width: 80%;
    }

    .message.system {
      background-color: var(--message-bg);
      text-align: left;
      align-self: flex-start;
    }

    .message.user {
      background-color: var(--user-message-bg);
      text-align: right;
      align-self: flex-end;
      margin-left: auto;
    }

    .message-avatar {
      width: 30px;
      height: 30px;
      border-radius: 3px;
      background-color: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
      font-weight: bold;
      color: white;
    }

    .message.user .message-avatar {
      background-color: #5436da;
    }

    .message-content {
      flex: 1;
      padding-right: 80px;
      line-height: 1.6;
    }

    .message-inner-container {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      width: 100%;
    }

    .log-entry {
      border: 3px solid var(--info-color);
      padding: 1rem;
      display: flex;
      align-items: flex-start;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      margin: 1rem 2rem;
      max-width: 100%;
    }

    .log-entry.warning {
      border-color: var(--warning-color);
    }

    .log-entry.error {
      border-color: var(--error-color);
    }

    .log-entry.success {
      border-color: var(--success-color);
    }

    .input-container {
      background-color: var(--bg-color);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .input-wrapper {
      max-width: 768px;
      width: 100%;
      margin: 0 auto;
      position: relative;
      display: flex;
      align-items: center;
    }

    #prompt-input {
      width: 100%;
      padding: 0;
      flex: 1;
      padding: 0.8rem 3rem 0.8rem 1rem;
      background-color: var(--user-message-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: var(--text-color);
      outline: none;
      resize: none;
      max-height: 200px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      font-size: 0.95rem;
      line-height: 1.4;
      min-height: 200px;
    }

    #prompt-input:focus {
      border-color: rgba(255, 255, 255, 0.3);
    }

    .send-button {
      width: 50px;
      height: 50px;
      position: absolute;
      right: 10px;
      bottom: 8px;
      background-color: transparent;
      color: var(--highlight-color);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .send-button:hover {
      color: var(--bg-color);
      background-color: var(--text-color);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-button .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    .send-button svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .new-task-button {
      margin: 0.8rem;
      padding: 0.75rem;
      background-color: var(--user-message-bg);
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
      text-align: center;
      font-size: 0.9rem;
    }

    .new-task-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .no-tasks {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    #context-badge {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(16, 163, 127, 0.2);
      color: var(--accent-color);
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 5;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        top: 44px;
        left: 0;
        height: calc(100% - 44px);
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.show {
        transform: translateX(0);
      }

      #toggle-sidebar {
        display: block;
      }

      .message-content {
        padding-right: 20px;
      }
    }

    #toggle-sidebar {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      display: none;
    }

    .notifications {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 100;
    }

    .notification {
      background-color: var(--secondary-bg);
      color: var(--text-color);
      padding: 0.8rem 1rem;
      margin-top: 0.5rem;
      border-radius: 4px;
      border-left: 3px solid var(--accent-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
      max-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }

    .code-preview {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 2rem;
      position: relative;
    }

    .code-preview pre {
      color: var(--text-color);
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }

    .code-preview button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--accent-color);
      color: var(--text-color);
      border: none;
      border-radius: 5px;
      padding: 0.5rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .code-preview button:hover {
      background-color: var(--highlight-color);
    }

    .stop-button {
      background-color: var(--error-color);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      right: 10px;
      bottom: 8px;
    }

    .stop-button:hover {
      background-color: #d32f2f;
    }

    .stop-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <body>
    <header>
      <img
        src="https://media.discordapp.net/attachments/1309250757937201245/1353360434245402738/logo.png?ex=67e15e9f&is=67e00d1f&hm=d111b4a1f2707f93b6b7f3b8dbcccf35c34b02dd1125b622d60cba243bc3c447&=&format=webp&quality=lossless&width=625&height=450"
        class="logo"
      />
      <div class="status-indicator">
        <div class="status-dot active" id="status-indicator"></div>
        <span id="status-text">Connected</span>
      </div>
      <button id="toggle-sidebar">≡</button>
    </header>

    <main>
      <div class="sidebar" id="sidebar">
        <div class="new-task-button" id="new-task-button">+ Nouvelle tache</div>
        <div class="task-list" id="task-list">
          <div class="no-tasks" id="no-tasks">Aucune discussion</div>
        </div>
      </div>

      <div class="chat-container">
        <div class="messages-container" id="messages-container">
          <!-- Messages will be added here by JavaScript -->
        </div>
        <div class="input-container">
          <div class="input-wrapper">
            <textarea
              id="prompt-input"
              placeholder="Envoyez un message..."
              rows="1"
            ></textarea>
            <button class="stop-button" id="stop-button" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M6 6h12v12H6z"></path>
              </svg>
            </button>
            <button class="send-button" id="send-button">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>

    <div id="context-badge">Discussion actuelle: Aucune</div>
    <div class="notifications" id="notifications"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const promptInput = document.getElementById("prompt-input");
        const sendButton = document.getElementById("send-button");
        const stopButton = document.getElementById("stop-button");
        const messagesContainer = document.getElementById("messages-container");
        const taskList = document.getElementById("task-list");
        const noTasksElement = document.getElementById("no-tasks");
        const newTaskButton = document.getElementById("new-task-button");
        const statusDot = document.getElementById("status-indicator");
        const statusText = document.getElementById("status-text");
        const contextBadge = document.getElementById("context-badge");
        const notificationsContainer = document.getElementById("notifications");
        const toggleSidebarButton = document.getElementById("toggle-sidebar");
        const sidebar = document.getElementById("sidebar");

        // State
        let tasks = [];
        let currentTaskId = null;
        let isProcessing = false;
        let abortController = null;

        // Initialize autoresize for textarea
        promptInput.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = this.scrollHeight + "px";
          if (this.scrollHeight > 200) {
            this.style.height = "200px";
          }
        });

        // Toggle sidebar on mobile
        toggleSidebarButton.addEventListener("click", () => {
          sidebar.classList.toggle("show");
        });

        // Create a new task
        newTaskButton.addEventListener("click", createNewTask);

        // Handle sending a prompt
        sendButton.addEventListener("click", () => sendPrompt());
        promptInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendPrompt();
          }
        });

        // Handle stopping the agent
        stopButton.addEventListener("click", () => {
          if (abortController) {
            abortController.abort();
            abortController = null;
            setProcessingState(false);
            showNotification("Agent stopped", "warning");
          }
        });

        // Create a websocket connection to the server
        const socket = new WebSocket(`ws://${window.location.host}/ws`);

        socket.onopen = () => {
          setConnectionStatus(true);
          showNotification("Connected to server", "success");
          addSystemMessage("Connected to OpenManus. Ready to assist you.");
        };

        socket.onclose = () => {
          setConnectionStatus(false);
          showNotification("Disconnected from server", "error");
          addSystemMessage(
            "Connection lost. Please refresh the page to reconnect."
          );
        };

        socket.onerror = (error) => {
          console.error("WebSocket error:", error);
          showNotification("Connection error", "error");
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === "log") {
            addLogEntry(data.message, data.level || "info");

            if (
              data.level === "success" ||
              data.message.includes("completed")
            ) {
              setProcessingState(false);
            }
          } else if (data.type === "response") {
            addSystemMessage(data.message);
            setProcessingState(false);
          } else if (data.type === "error") {
            addLogEntry(data.message, "error");
            showNotification(data.message, "error");
            setProcessingState(false);
          } else if (data.type === "processing") {
            setProcessingState(true);
          }
        };

        // Function to send a prompt to the server
        function sendPrompt() {
          const prompt = promptInput.value.trim();
          if (!prompt || isProcessing) return;

          if (!currentTaskId) {
            createNewTask().then(() => {
              executePrompt(prompt);
            });
          } else {
            executePrompt(prompt);
          }
        }

        function executePrompt(prompt) {
          // Add user message to the UI
          addUserMessage(prompt);

          // Clear input field
          promptInput.value = "";
          promptInput.style.height = "auto";

          // Set processing state
          setProcessingState(true);

          // Create AbortController for stopping the agent
          abortController = new AbortController();

          // Send to server
          sendToServer({
            type: "prompt",
            prompt: prompt,
            taskId: currentTaskId,
            signal: abortController.signal,
          });
        }

        function sendToServer(data) {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(data));
          } else {
            showNotification("Connection not available", "error");
            setProcessingState(false);
          }
        }

        // UI Helper Functions
        function setConnectionStatus(isConnected) {
          if (isConnected) {
            statusDot.classList.remove("inactive");
            statusDot.classList.add("active");
            statusText.textContent = "Connected";
          } else {
            statusDot.classList.remove("active");
            statusDot.classList.add("inactive");
            statusText.textContent = "Disconnected";
          }
        }

        function setProcessingState(processing) {
          isProcessing = processing;

          if (processing) {
            sendButton.disabled = true;
            sendButton.style.display = "none";
            stopButton.disabled = false;
            stopButton.style.display = "flex";
          } else {
            sendButton.disabled = false;
            sendButton.style.display = "flex";
            stopButton.disabled = true;
            stopButton.style.display = "none";
          }
        }

        function addUserMessage(content) {
          const messageElement = document.createElement("div");
          messageElement.className = "message user";

          const contentElement = document.createElement("div");
          contentElement.className = "message-content";
          contentElement.textContent = content;

          const timestampElement = document.createElement("div");
          timestampElement.className = "timestamp";
          timestampElement.textContent = getCurrentTime();

          messageElement.appendChild(contentElement);
          messageElement.appendChild(timestampElement);

          messagesContainer.appendChild(messageElement);
          scrollToBottom();

          // Also update the task preview if this is in a task
          if (currentTaskId) {
            updateTaskPreview(currentTaskId, content);
          }
        }

        function addSystemMessage(content) {
          const messageElement = document.createElement("div");
          messageElement.className = "message system";

          const contentElement = document.createElement("div");
          contentElement.className = "message-content";
          contentElement.textContent = content;

          const timestampElement = document.createElement("div");
          timestampElement.className = "timestamp";
          timestampElement.textContent = getCurrentTime();

          messageElement.appendChild(contentElement);
          messageElement.appendChild(timestampElement);

          messagesContainer.appendChild(messageElement);
          scrollToBottom();
        }

        function addLogEntry(content, level = "info") {
          const logElement = document.createElement("div");
          logElement.className = `log-entry ${level}`;
          logElement.textContent = content;

          messagesContainer.appendChild(logElement);
          scrollToBottom();
        }

        function addCodePreview(content) {
          const codePreview = document.createElement("div");
          codePreview.className = "code-preview";

          const pre = document.createElement("pre");
          pre.textContent = content;

          const copyButton = document.createElement("button");
          copyButton.textContent = "Copy";
          copyButton.addEventListener("click", () => {
            navigator.clipboard.writeText(content);
            showNotification("Code copied to clipboard", "success");
          });

          codePreview.appendChild(pre);
          codePreview.appendChild(copyButton);

          messagesContainer.appendChild(codePreview);
          scrollToBottom();
        }

        function scrollToBottom() {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getCurrentTime() {
          const now = new Date();
          return now.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        function getFormattedDate() {
          const now = new Date();
          return (
            now.toLocaleDateString() +
            " " +
            now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
          );
        }

        function showNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.className = `notification ${type}`;
          notification.textContent = message;

          notificationsContainer.appendChild(notification);

          // Remove notification after animation completes
          setTimeout(() => {
            notification.remove();
          }, 3000);
        }

        // Task Management Functions
        async function createNewTask() {
          const taskId = "task_" + Date.now();
          const timestamp = getFormattedDate();
          const newTask = {
            id: taskId,
            title: "New Task",
            preview: "No content yet",
            timestamp: timestamp,
            messages: [],
          };

          tasks.push(newTask);
          createTaskElement(newTask);
          selectTask(taskId);
          updateLocalStorage();

          return taskId;
        }

        function createTaskElement(task) {
          noTasksElement.style.display = "none";
          const taskElement = document.createElement("div");
          taskElement.className = "task-item";
          taskElement.id = `task-${task.id}`;
          taskElement.dataset.taskId = task.id;

          const titleElement = document.createElement("div");
          titleElement.className = "task-title";
          titleElement.textContent = task.title;

          const previewElement = document.createElement("div");
          previewElement.className = "task-preview";
          previewElement.textContent = task.preview;

          const timestampElement = document.createElement("div");
          timestampElement.className = "timestamp";
          timestampElement.textContent = task.timestamp;

          taskElement.appendChild(titleElement);
          taskElement.appendChild(previewElement);
          taskElement.appendChild(timestampElement);

          taskElement.addEventListener("click", () => {
            selectTask(task.id);
          });

          taskList.insertBefore(taskElement, taskList.firstChild);
        }

        function selectTask(taskId) {
          // Remove selection from all tasks
          document.querySelectorAll(".task-item").forEach((item) => {
            item.classList.remove("selected");
          });

          // Add selection to current task
          const taskElement = document.getElementById(`task-${taskId}`);
          if (taskElement) {
            taskElement.classList.add("selected");
          }

          currentTaskId = taskId;
          messagesContainer.innerHTML = "";

          // Load messages from this task
          const task = tasks.find((t) => t.id === taskId);
          if (task) {
            if (task.messages && task.messages.length > 0) {
              task.messages.forEach((msg) => {
                if (msg.sender === "user") {
                  addUserMessage(msg.content);
                } else {
                  addSystemMessage(msg.content);
                }
              });
            } else {
              addSystemMessage("New task started. Enter your prompt to begin.");
            }

            // Update context badge
            contextBadge.textContent = `Current task: ${task.title}`;
            contextBadge.style.opacity = "1";
            setTimeout(() => {
              contextBadge.style.opacity = "0";
            }, 3000);
          }

          // On mobile, hide sidebar after selection
          if (window.innerWidth <= 768) {
            sidebar.classList.remove("show");
          }
        }

        function updateTaskPreview(taskId, content) {
          const task = tasks.find((t) => t.id === taskId);
          if (task) {
            task.preview =
              content.length > 40 ? content.substring(0, 40) + "..." : content;
            task.title = `Task ${tasks.indexOf(task) + 1}`;
            task.messages.push({
              sender: "user",
              content: content,
              timestamp: new Date().toISOString(),
            });

            const taskElement = document.getElementById(`task-${taskId}`);
            if (taskElement) {
              const titleElement = taskElement.querySelector(".task-title");
              const previewElement = taskElement.querySelector(".task-preview");

              if (titleElement) titleElement.textContent = task.title;
              if (previewElement) previewElement.textContent = task.preview;
            }

            updateLocalStorage();
          }
        }

        function storeSystemResponse(content) {
          if (currentTaskId) {
            const task = tasks.find((t) => t.id === currentTaskId);
            if (task) {
              task.messages.push({
                sender: "system",
                content: content,
                timestamp: new Date().toISOString(),
              });
              updateLocalStorage();
            }
          }
        }

        function updateLocalStorage() {
          localStorage.setItem("openmanus_tasks", JSON.stringify(tasks));
        }

        function loadTasksFromStorage() {
          const storedTasks = localStorage.getItem("openmanus_tasks");
          if (storedTasks) {
            tasks = JSON.parse(storedTasks);
            if (tasks.length > 0) {
              noTasksElement.style.display = "none";
              tasks.forEach((task) => createTaskElement(task));
            }
          }
        }

        // Initialize
        loadTasksFromStorage();
      });
    </script>
  </body>
</html>
